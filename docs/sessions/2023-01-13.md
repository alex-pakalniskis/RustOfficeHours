# 2023-01-13
Deserialize subgraph manifest YAML

<br>
<br>

**This week's data**
* https://ipfs.io/ipfs/QmbW34MGRyp7LWkpDyKXDLWsKrN8iqZrNAMjGTYHN2zHa1


<br>
<br>

**Let's jump into some code**

From your terminal/command line, create a new `cargo` project and open it with VSCode

``` bash
cargo new parse_subgraph_manifest
cd parse_subgraph_manifest
code .
```
<br>
<br>

With VSCode now open, update Cargo.toml with the following dependencies (add this below [dependencies]) then save your changes

``` toml
reqwest = { version = "0.11.13", features = ["json"] }
tokio = { version = "1.23.0", features = ["full"] }
serde = { version = "1.0.152",  features = ["derive"]}
serde_yaml = "0.9.16"
```
<br>
<br>

Create a new file called src/utils.rs and add these `use` statements

``` rust
use std::collections::HashMap;
use std::string::String;
use serde::Deserialize;
```
<br>
<br>

Next, add some `struct` statments to the same file the save

``` rust
#[allow(non_snake_case)]
#[derive(Debug, Deserialize)]
pub struct SubgraphManifest {
    pub dataSources: Vec<DataSource>,
    pub description: String,
    pub repository: String,
    pub specVersion: String,
    pub schema: SchemaAddress,
}

#[allow(non_snake_case)]
#[derive(Debug, Deserialize)]
pub struct SchemaAddress {
    pub file: HashMap<String, String>,
}

#[allow(non_snake_case)]
#[derive(Debug, Deserialize)]
pub struct DataSource {
    pub kind: String,
    pub mapping: Mapping,
    pub name: String,
    pub network: String,
    pub source: Source,
}

#[allow(non_snake_case)]
#[derive(Debug, Deserialize)]
pub struct Mapping {
    pub abis: serde_yaml::Sequence,
    pub apiVersion: String,
    pub entities: serde_yaml::Sequence,
    pub eventHandlers: serde_yaml::Sequence,
    pub file: HashMap<String, String>,
    pub kind: String,
    pub language: String,
}

#[allow(non_snake_case)]
#[derive(Debug, Deserialize)]
pub struct Source {
    pub abi: String,
    pub address: String,
    pub startBlock: u32,
}
```
<br>
<br>

Navigate to src/main.rs and add the following `use` and `mod` statements

``` rust
use std::error::Error;

mod utils;
use crate::utils::SubgraphManifest;
```

<br>
<br>

Now add a `main` function

``` rust
#[tokio::main]
async fn main() -> Result<(), Box<dyn Error>> {

    let manifest_response = reqwest::get("https://ipfs.io/ipfs/QmbW34MGRyp7LWkpDyKXDLWsKrN8iqZrNAMjGTYHN2zHa1")
    .await?
    .text()
    .await?;

    let manifest_data: SubgraphManifest = serde_yaml::from_str(&manifest_response).unwrap();

    println!("{:?}", manifest_data);

    Ok(())
}
```

<br>
<br>

Save your changes then run the program from the integrated terminal in VSCode

``` bash
cargo run
```

<br>
<br>


Let's add a test below the `main` function 

``` rust
#[tokio::test]
async fn deserialize_everest_subgraph_manifest_repo()-> Result<(), Box<dyn Error>> {
    let manifest_response = reqwest::get("https://ipfs.io/ipfs/QmVsp1bC9rS3rf861cXgyvsqkpdsTXKSnS4729boXZvZyH")
    .await?
    .text()
    .await?;

    let manifest_data: SubgraphManifest = serde_yaml::from_str(&manifest_response).unwrap();

    let subgraph_manifest_repository = "https://github.com/graphprotocol/everest";

    assert_eq!(manifest_data.repository, subgraph_manifest_repository);

    Ok(())
}
```

<br>
<br>


Run your test

``` bash
cargo test
```



